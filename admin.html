<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Node | primeP2Pxchange</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" type="image/png" href="p2plogo.png">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #05070a; color: #f8fafc; overflow-x: hidden; }
        .glass-panel { background: rgba(15, 19, 26, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .btn-release { background: linear-gradient(135deg, #10b981 0%, #059669 100%); transition: all 0.3s ease; }
        .tab-btn.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
        .market-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; width: 100%; }
        #toastContainer { position: fixed; top: 1rem; right: 1rem; left: 1rem; z-index: 2000; pointer-events: none; }
        @media (min-width: 768px) { #toastContainer { left: auto; width: 400px; } }
        .toast { pointer-events: auto; transform: translateY(-150%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); opacity: 0; }
        .toast.show { transform: translateX(0); opacity: 1; }
        .modal-overlay { transition: opacity 0.3s ease; opacity: 0; pointer-events: none; visibility: hidden; z-index: 1000; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; visibility: visible; }
        .tab-content { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .mobile-nav { scrollbar-width: none; -ms-overflow-style: none; }
        .mobile-nav::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 md:p-12">

    <div id="toastContainer" class="flex flex-col gap-3"></div>

    <div id="confirmModal" class="fixed inset-0 flex items-center justify-center px-4 modal-overlay">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md"></div>
        <div class="glass-panel w-full max-w-[380px] p-8 rounded-[2.5rem] relative z-10 border-white/10 text-center">
            <div id="confirmIcon" class="w-14 h-14 bg-blue-600/10 rounded-2xl flex items-center justify-center mx-auto mb-4 text-blue-400">
                <i data-lucide="help-circle" class="w-7 h-7"></i>
            </div>
            <h3 id="confirmTitle" class="text-lg font-black text-white mb-2">Are you sure?</h3>
            <p id="confirmDesc" class="text-slate-400 text-xs mb-8 leading-relaxed">This action updates network node data immediately.</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 py-3.5 bg-white/5 text-white rounded-xl font-bold text-xs transition">Cancel</button>
                <button id="confirmExecuteBtn" class="flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-black text-xs transition">Confirm</button>
            </div>
        </div>
    </div>

    <div id="marketModal" class="fixed inset-0 flex items-center justify-center px-4 modal-overlay">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md" onclick="closeMarketModal()"></div>
        <div class="glass-panel w-full max-w-[480px] p-6 md:p-10 rounded-[2.5rem] relative z-10 border-blue-500/30">
            <h3 class="text-xl font-black text-white mb-6 uppercase italic tracking-tighter">Initialize Liquidity Node</h3>
            <div class="grid grid-cols-2 gap-3 text-left">
                <div class="col-span-2 space-y-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2">Node ID / Name</label>
                    <input id="mkName" type="text" class="w-full bg-black/40 border border-white/5 p-3.5 rounded-xl text-sm text-white outline-none focus:border-blue-500" placeholder="e.g. Nile_Liquidity">
                </div>
                <div class="col-span-2 space-y-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2">Merchant Profile Photo</label>
                    <div class="flex gap-2">
                        <input id="mkFile" type="file" accept="image/*" class="hidden" onchange="handleAdminFileSelect(this)">
                        <button onclick="document.getElementById('mkFile').click()" class="flex-1 bg-black/40 border border-white/5 p-3.5 rounded-xl text-xs text-slate-400 text-left hover:border-blue-500 transition truncate">
                            <span id="mkFileName">Select Image File...</span>
                        </button>
                    </div>
                    <input type="hidden" id="mkBase64">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2">Asset</label>
                    <select id="mkAsset" class="w-full bg-black/40 border border-white/5 p-3.5 rounded-xl text-sm text-white outline-none">
                        <option value="USDT">USDT</option><option value="BTC">BTC</option><option value="SOL">SOL</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-500 uppercase ml-2">Node Action</label>
                    <select id="mkType" class="w-full bg-black/40 border border-white/5 p-3.5 rounded-xl text-sm text-white outline-none">
                        <option value="buy">BUY</option><option value="sell">SELL</option>
                    </select>
                </div>
                <div class="space-y-1"><label class="text-[9px] font-black text-slate-500 uppercase ml-2">Rate (USD)</label><input id="mkPrice" type="number" class="w-full bg-black/40 border border-white/5 p-3.5 rounded-xl text-sm text-white outline-none"></div>
                <div class="space-y-1"><label class="text-[9px] font-black text-slate-500 uppercase ml-2">Rails</label><input id="mkPayment" type="text" class="w-full bg-black/40 border border-white/5 p-3.5 rounded-xl text-sm text-white outline-none" placeholder="M-PESA"></div>
                <div class="space-y-1"><label class="text-[9px] font-black text-slate-500 uppercase ml-2">Min</label><input id="mkMin" type="number" class="w-full bg-black/40 border border-white/5 p-3.5 rounded-xl text-sm text-white outline-none"></div>
                <div class="space-y-1"><label class="text-[9px] font-black text-slate-500 uppercase ml-2">Max</label><input id="mkMax" type="number" class="w-full bg-black/40 border border-white/5 p-3.5 rounded-xl text-sm text-white outline-none"></div>
            </div>
            <button onclick="saveMarketMaker()" id="saveMkBtn" class="w-full py-4 mt-6 bg-blue-600 text-white rounded-xl font-black text-xs uppercase shadow-lg active:scale-95 transition">Deploy Node Listing</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-8">
            <div>
                <h1 class="text-2xl md:text-3xl font-black text-white flex items-center gap-3"><i data-lucide="shield-alert" class="text-blue-500 w-6 md:w-8"></i> primeAdmin</h1>
                <p class="text-slate-500 text-[10px] md:text-sm mt-1 uppercase font-bold tracking-widest">Node Command Center</p>
            </div>
            <div class="flex items-center gap-3 w-full md:w-auto">
                <button onclick="loadAdminData()" class="glass-panel flex-1 md:flex-none p-3 rounded-xl text-blue-400 flex items-center justify-center active:scale-95"><i data-lucide="refresh-cw" class="w-5"></i></button>
                <div class="bg-blue-600/10 border border-blue-500/20 px-4 py-3 rounded-xl text-blue-400 text-[9px] font-black uppercase flex-1 text-center">Root Terminal</div>
            </div>
        </header>

        <div class="grid lg:grid-cols-3 gap-6 mb-12">
            <div class="glass-panel p-8 rounded-[2.5rem] border-blue-500/20 relative overflow-hidden group text-left">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Gateway Balance</p>
                        <h3 class="text-3xl font-black text-white" id="gatewayBalance">~ $0.00</h3>
                    </div>
                    <div class="w-12 h-12 bg-blue-600/10 rounded-2xl flex items-center justify-center text-blue-400">
                        <i data-lucide="wallet"></i>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="flex justify-between text-[10px] font-bold"><span class="text-slate-500">Auto-Payout</span><span class="text-green-500 uppercase">Active</span></div>
                    <div class="w-full bg-white/5 h-1.5 rounded-full overflow-hidden">
                        <div class="bg-blue-600 h-full w-[10.17%]" style="width: 10.17%;"></div>
                    </div>
                    <p class="text-[9px] text-slate-500 font-medium italic">Settling directly to TRC-20 Node</p>
                </div>
            </div>

            <div class="glass-panel p-8 rounded-[2.5rem] border-white/5 col-span-2 text-left">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-[10px] font-black uppercase text-white tracking-widest">Live Gateway Settlement Flow</h3>
                    <span class="text-[9px] font-bold text-blue-400 uppercase animate-pulse">REST Sync Active</span>
                </div>
                <div id="payoutHistory" class="space-y-3 max-h-[160px] overflow-y-auto pr-2 mobile-nav text-xs text-slate-500 italic">
                    Polling secure gateway signals...
                </div>
            </div>
        </div>

        <div class="mobile-nav flex gap-4 border-b border-white/5 mb-8 overflow-x-auto whitespace-nowrap pb-1">
            <button onclick="switchTab('trades')" id="tabBtn-trades" class="tab-btn active pb-4 text-[11px] font-black uppercase tracking-widest px-2">Queue</button>
            <button onclick="switchTab('withdrawals')" id="tabBtn-withdrawals" class="tab-btn pb-4 text-[11px] font-black uppercase tracking-widest px-2 text-slate-500">Withdrawals</button>
            <button onclick="switchTab('identity')" id="tabBtn-identity" class="tab-btn pb-4 text-[11px] font-black uppercase tracking-widest px-2 text-slate-500">Identity</button>
            <button onclick="switchTab('support')" id="tabBtn-support" class="tab-btn pb-4 text-[11px] font-black uppercase tracking-widest px-2 text-slate-500">Support Inbox</button>
            <button onclick="switchTab('users')" id="tabBtn-users" class="tab-btn pb-4 text-[11px] font-black uppercase tracking-widest px-2 text-slate-500">Users</button>
            <button onclick="switchTab('market')" id="tabBtn-market" class="tab-btn pb-4 text-[11px] font-black uppercase tracking-widest px-2 text-slate-500">Market</button>
            <button onclick="switchTab('broadcast')" id="tabBtn-broadcast" class="tab-btn pb-4 text-[11px] font-black uppercase tracking-widest px-2 text-slate-500">Broadcast</button>
            <button onclick="switchTab('logs')" id="tabBtn-logs" class="tab-btn pb-4 text-[11px] font-black uppercase tracking-widest px-2 text-slate-500">System Logs</button>
        </div>

        <div id="tab-trades" class="tab-content grid gap-4"><div id="adminLedger" class="market-grid"></div></div>
        <div id="tab-withdrawals" class="tab-content hidden grid gap-4"><div id="withdrawalQueue" class="market-grid"></div></div>
        <div id="tab-identity" class="tab-content hidden grid gap-6"><div id="kycReviewQueue" class="market-grid"></div></div>
        <div id="tab-support" class="tab-content hidden"><div id="supportQueue" class="grid gap-4 max-h-[70vh] overflow-y-auto pr-2 mobile-nav"></div></div>
        <div id="tab-users" class="tab-content hidden grid gap-4"><div id="userTableBody" class="market-grid"></div></div>
        <div id="tab-market" class="tab-content hidden"><div class="flex justify-between items-center mb-6"><h3 class="font-black text-white text-[10px] uppercase">Liquidity</h3><button onclick="openMarketModal()" class="bg-blue-600 px-5 py-2 rounded-xl text-[9px] font-black text-white">+ New Pair</button></div><div class="market-grid" id="marketGrid"></div></div>
        <div id="tab-broadcast" class="tab-content hidden"><div class="glass-panel p-6 rounded-[2rem] border-blue-500/20 max-w-xl mx-auto text-center"><h3 class="text-xl font-black text-white mb-6">Priority Signal</h3><textarea id="broadcastMsg" rows="4" class="w-full bg-black/40 border border-white/5 p-5 rounded-2xl text-sm text-white outline-none focus:border-blue-500 transition mb-6" placeholder="Message all nodes..."></textarea><button onclick="sendGlobalBroadcast()" id="broadcastBtn" class="w-full py-4 bg-blue-600 text-white rounded-xl font-black text-xs uppercase transition">Execute Broadcast</button></div></div>
        <div id="tab-logs" class="tab-content hidden"><div id="logContainer" class="grid gap-2 max-h-[60vh] overflow-y-auto pr-2 mobile-nav"></div></div>
    </div>

    <script>
        lucide.createIcons();
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyaqvKDKq21WBqCvtGO2APfxorT1VRwRIyBNybB5fYfqHH_CZ42jpEjqEiNZOCI3Kk/exec";

        function openMarketModal() { document.getElementById('marketModal').classList.add('show'); }
        function closeMarketModal() { document.getElementById('marketModal').classList.remove('show'); }
        function openConfirmModal(title, desc, onConfirm, type = 'info') {
            document.getElementById('confirmTitle').innerText = title; document.getElementById('confirmDesc').innerText = desc;
            const btn = document.getElementById('confirmExecuteBtn');
            btn.className = type === 'danger' ? "flex-1 py-3.5 bg-red-600 text-white rounded-xl font-black text-xs transition" : "flex-1 py-3.5 bg-blue-600 text-white rounded-xl font-black text-xs transition";
            btn.onclick = () => { onConfirm(); closeConfirmModal(); }; document.getElementById('confirmModal').classList.add('show');
        }
        function closeConfirmModal() { document.getElementById('confirmModal').classList.remove('show'); }

        async function loadAdminData() {
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_get_all_data' }) });
                const data = await response.json();
                const logRes = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_get_logs' }) });
                const logData = await logRes.json();
                if (data.success) { 
                    renderTrades(data.trades, logData.logs); 
                    renderWithdrawals(data.trades); 
                    renderUsers(data.users); 
                    renderMarket(data.market);
                    renderSupport(data.support); 
                    if (data.gateway) renderGatewayData(data.gateway); //
                    if (logData.success) {
                        renderKYCQueue(data.users, logData.logs);
                        renderLogs(logData.logs);
                    }
                }
            } catch (e) { showToast("Sync Error", "error"); }
        }

        function renderGatewayData(gateway) {
            const balDisplay = document.getElementById('gatewayBalance');
            if (gateway.balance && gateway.balance.usdttrc20) {
                balDisplay.innerText = `$${parseFloat(gateway.balance.usdttrc20.amount).toFixed(2)}`;
            }
            const historyContainer = document.getElementById('payoutHistory');
            if (!gateway.history || gateway.history.length === 0) {
                historyContainer.innerHTML = `<p class="text-xs text-slate-500 italic">No recent transactions.</p>`;
                return;
            }
            historyContainer.innerHTML = gateway.history.map(p => `
                <div class="flex justify-between items-center p-3 rounded-xl bg-white/[0.02] border border-white/5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-600/10 flex items-center justify-center text-[10px] font-black text-blue-400">${p.pay_currency.toUpperCase()}</div>
                        <div><p class="text-[10px] font-bold text-white uppercase">${p.order_id || 'Node Credit'}</p><p class="text-[8px] text-slate-600 font-bold">${new Date(p.created_at).toLocaleString()}</p></div>
                    </div>
                    <div class="text-right"><p class="text-[10px] font-black text-white">$${p.price_amount}</p><p class="text-[8px] font-black uppercase ${p.payment_status === 'finished' ? 'text-green-500' : 'text-orange-500'}">${p.payment_status}</p></div>
                </div>`).join('');
            lucide.createIcons();
        }

        function renderSupport(tickets) {
            const container = document.getElementById('supportQueue');
            if (!tickets || tickets.length === 0) {
                container.innerHTML = `<div class="glass-panel p-10 rounded-2xl text-center text-slate-500 italic text-sm">Inbox Clear. No active support signals.</div>`;
                return;
            }
            container.innerHTML = tickets.map(t => `
                <div class="glass-panel p-6 rounded-[2rem] border-white/5 flex flex-col md:row justify-between gap-6 text-left hover:bg-white/[0.02] transition">
                    <div class="flex-1 space-y-2">
                        <div class="flex items-center gap-3"><span class="px-2 py-0.5 rounded bg-blue-600/10 text-blue-400 text-[8px] font-black uppercase">${t.subject}</span><span class="text-[8px] text-slate-600 font-bold">${new Date(t.timestamp).toLocaleString()}</span></div>
                        <h4 class="text-sm font-bold text-white">${t.email}</h4><p class="text-xs text-slate-400 leading-relaxed">${t.message}</p>
                    </div>
                    <div class="flex items-center gap-3"><button onclick="showToast('Signal archived', 'success')" class="px-6 py-2.5 bg-green-600 text-white rounded-xl font-black text-[9px] uppercase active:scale-95 transition">Resolve</button><button onclick="window.location.href='mailto:${t.email}'" class="p-2.5 glass-panel rounded-xl text-blue-400 hover:text-white transition"><i data-lucide="mail" class="w-4 h-4"></i></button></div>
                </div>`).join('');
            lucide.createIcons();
        }

        function renderTrades(trades, logs) {
            const container = document.getElementById('adminLedger');
            const pending = trades.filter(t => t.status === "PAID" && t.merchant !== "WITHDRAWAL");
            if (pending.length === 0) { container.innerHTML = `<div class="glass-panel p-10 rounded-2xl text-center text-slate-500 italic text-sm col-span-full">Clear Trade Queue.</div>`; return; }
            container.innerHTML = pending.map(t => {
                const proofLog = logs.find(l => l[3].includes(t.tradeId) && l[2] === "PROOF_UPLOADED");
                const proofUrl = proofLog ? proofLog[3].split('|')[1] : "";
                return `<div class="glass-panel p-5 rounded-[1.5rem] border-white/5 space-y-3 text-left">
                    <div class="flex justify-between items-start"><div><p class="text-[7px] font-black text-blue-500 uppercase tracking-widest">${t.tradeId}</p><h4 class="text-[10px] font-bold text-white truncate w-32">${t.userEmail}</h4></div><span class="px-2 py-0.5 rounded bg-orange-500/10 text-orange-500 text-[7px] font-black uppercase">PAID</span></div>
                    <div class="bg-black/40 p-3 rounded-xl space-y-1"><div class="flex justify-between text-[10px] font-black text-white"><span>Amt</span><span>$${t.amount}</span></div><div class="flex justify-between text-[9px] font-bold text-green-400 border-t border-white/5 pt-1.5"><span>Rel</span><span>${t.crypto} ${t.asset}</span></div></div>
                    <div class="aspect-video bg-black/60 rounded-lg border border-white/5 overflow-hidden">${proofUrl ? `<iframe src="${proofUrl}" class="w-full h-full border-none"></iframe>` : `<div class="w-full h-full flex items-center justify-center text-slate-700 text-[7px] font-bold uppercase italic">Missing Upload</div>`}</div>
                    <div class="flex gap-2 mt-2"><button onclick="releaseEscrow('${t.tradeId}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-black text-[9px] uppercase active:scale-95 transition">Release</button><button onclick="rejectTrade('${t.tradeId}')" class="flex-1 bg-red-600/10 text-red-500 py-2 rounded-lg font-black text-[9px] uppercase border border-red-500/20 active:scale-95 transition">Reject</button></div>
                </div>`;
            }).join('');
        }

        function renderWithdrawals(trades) {
            const container = document.getElementById('withdrawalQueue');
            const requests = trades.filter(t => t.merchant === "WITHDRAWAL" && t.status === "PENDING_APPROVAL");
            if (requests.length === 0) { container.innerHTML = `<div class="glass-panel p-10 rounded-2xl text-center text-slate-500 italic text-sm col-span-full">No Pending Withdrawals.</div>`; return; }
            container.innerHTML = requests.map(r => `
                <div class="glass-panel p-4 rounded-xl border-red-500/10 text-left">
                    <div class="flex justify-between items-start mb-2"><div><p class="text-[7px] font-black text-red-500 uppercase">${r.tradeId}</p><h4 class="text-[10px] font-bold text-white truncate w-32">${r.userEmail}</h4></div></div>
                    <div class="bg-black/40 p-3 rounded-lg space-y-1">
                        <div class="flex justify-between text-[10px] font-black text-white"><span>Amt</span><span class="text-red-400">$${r.amount}</span></div>
                        <div class="flex flex-col gap-0.5 border-t border-white/5 pt-1"><span class="text-[7px] text-slate-500 uppercase font-black">To: ${r.asset}</span><span class="text-[8px] font-mono text-blue-400 break-all leading-tight">${r.crypto}</span></div>
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="approveWithdrawal('${r.tradeId}')" class="flex-1 py-2 bg-green-600 text-white rounded-lg font-black text-[8px] uppercase active:scale-95">Approve</button>
                        <button onclick="rejectWithdrawal('${r.tradeId}')" class="flex-1 py-2 bg-red-600/10 text-red-500 border border-red-500/20 rounded-lg font-black text-[8px] uppercase active:scale-95">Reject</button>
                    </div>
                </div>`).join('');
        }

        function renderKYCQueue(users, logs) {
            const container = document.getElementById('kycReviewQueue');
            const pendingUsers = users.filter(u => u.kyc === 1.5);
            if (pendingUsers.length === 0) { container.innerHTML = `<div class="glass-panel p-10 rounded-2xl text-center text-slate-500 italic text-sm col-span-full uppercase font-black">No pending Identity Nodes.</div>`; return; }
            container.innerHTML = pendingUsers.map(u => {
                const kycLog = logs.find(l => l[1] === u.email && l[2] === "KYC_PENDING");
                const meta = kycLog ? JSON.parse(kycLog[3]) : { docType: "Unknown", front: "", selfie: "" };
                return `<div class="glass-panel p-5 rounded-[1.5rem] border-white/5 space-y-4 text-left"><div class="flex justify-between items-start"><div><h4 class="text-xs font-bold text-white">${u.name}</h4><p class="text-[8px] text-blue-400 font-black uppercase tracking-widest">${meta.docType}</p></div><div class="flex gap-1.5"><button onclick="processKYC('${u.email}', 'APPROVE')" class="bg-green-600 text-white px-2.5 py-1 rounded-lg text-[8px] font-black uppercase">Approve</button><button onclick="processKYC('${u.email}', 'REJECT')" class="bg-red-600 text-white px-2.5 py-1 rounded-lg text-[8px] font-black uppercase">Reject</button></div></div><div class="grid grid-cols-2 gap-2"><div class="aspect-video bg-black/40 rounded-lg border border-white/5 overflow-hidden"><iframe src="${meta.front}" class="w-full h-full border-none"></iframe></div><div class="aspect-video bg-black/40 rounded-lg border border-white/5 overflow-hidden"><iframe src="${meta.selfie}" class="w-full h-full border-none"></iframe></div></div></div>`;
            }).join('');
        }

        async function rejectWithdrawal(id) {
            openConfirmModal("Reject & Refund", "Invalid address or node error? This will return the funds to the user balance immediately.", async () => {
                try {
                    const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'reject_withdrawal_request', tradeId: id }) });
                    const result = await res.json();
                    if(result.success) { showToast(result.message, "success"); loadAdminData(); }
                } catch (e) { showToast("Refund Signal Failure", "error"); }
            }, 'danger');
        }

        async function approveWithdrawal(id) {
            openConfirmModal("Settlement Approval", "Confirm manual transfer sent? Trade will be marked COMPLETED.", async () => {
                try {
                    const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_approve_withdrawal', tradeId: id }) });
                    const result = await res.json();
                    if(result.success) { showToast(result.message, "success"); loadAdminData(); }
                } catch (e) { showToast("Signal Failure", "error"); }
            }, 'info');
        }

        async function releaseEscrow(id) {
            openConfirmModal("Authorize Release", "Synchronize global ledger assets?", async () => {
                try {
                    const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_release_escrow', tradeId: id }) });
                    const result = await res.json();
                    if(result.success) { showToast("Trade Finalized", "success"); loadAdminData(); }
                } catch (e) { showToast("Sync Error", "error"); }
            });
        }

        async function rejectTrade(id) {
            openConfirmModal("Reject Transaction", "Cancel this session?", async () => {
                try {
                    const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'update_trade_status', tradeId: id, status: 'REJECTED' }) });
                    const result = await res.json();
                    if(result.success) { showToast("Transaction Rejected", "error"); loadAdminData(); }
                } catch (e) { showToast("Signal Failure", "error"); }
            }, 'danger');
        }

        function renderUsers(users) {
            const container = document.getElementById('userTableBody');
            container.innerHTML = users.map(u => `<div class="glass-panel p-3 rounded-xl flex items-center justify-between border-white/5 text-left"><div><h4 class="text-[9px] font-bold text-white truncate w-32">${u.name}</h4><p class="text-[7px] text-slate-500 uppercase">${u.email}</p></div><button onclick="toggleUserStatus('${u.email}', '${u.status}')" class="px-2.5 py-1 rounded bg-white/5 text-[7px] font-black uppercase ${u.status === 'ACTIVE' ? 'text-red-400' : 'text-green-400'}">${u.status === 'ACTIVE' ? 'Ban' : 'Active'}</button></div>`).join('');
        }

        function renderMarket(market) {
            const grid = document.getElementById('marketGrid');
            grid.innerHTML = market.map(m => `<div class="glass-panel p-3 rounded-xl border-white/5 relative text-left"><button onclick="deleteMarket('${m.merchant}', '${m.asset}')" class="absolute top-2 right-2 text-red-500/40"><i data-lucide="trash-2" class="w-3"></i></button><p class="text-[6px] font-black text-blue-400 uppercase tracking-widest">${m.type} ${m.asset}</p><h4 class="text-[9px] font-black text-white mt-0.5">${m.merchant}</h4><div class="mt-1 text-[11px] font-black text-green-400">$${m.price}</div></div>`).join('');
            lucide.createIcons();
        }

        function renderLogs(logs) {
            const container = document.getElementById('logContainer');
            container.innerHTML = logs.map(l => `<div class="glass-panel p-3 rounded-lg border-white/5 flex flex-col gap-0.5 text-left"><div class="flex justify-between items-center"><span class="text-[8px] font-black uppercase text-blue-400">${l[2]}</span><span class="text-[7px] text-slate-600">${new Date(l[0]).toLocaleTimeString()}</span></div><p class="text-[9px] text-white leading-tight uppercase">${l[3]}</p></div>`).join('');
        }

        function handleAdminFileSelect(i) { if (i.files && i.files[0]) { const r = new FileReader(); r.onload = (e) => { document.getElementById('mkBase64').value = e.target.result; document.getElementById('mkFileName').innerText = i.files[0].name; document.getElementById('mkFileName').className += " text-blue-400 font-bold"; }; r.readAsDataURL(i.files[0]); } }
        async function saveMarketMaker() { const p = { action: 'admin_manage_market', mode: 'add', merchant: document.getElementById('mkName').value, base64Image: document.getElementById('mkBase64').value, asset: document.getElementById('mkAsset').value, type: document.getElementById('mkType').value, price: document.getElementById('mkPrice').value, min: document.getElementById('mkMin').value, max: document.getElementById('mkMax').value, payment: document.getElementById('mkPayment').value }; if(!p.merchant || !p.base64Image) return showToast("Required fields empty", "error"); const b = document.getElementById('saveMkBtn'); b.innerText = "Transforming..."; b.disabled = true; try { const r = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(p) }); const res = await r.json(); if(res.success) { showToast("Listing Node Added", "success"); closeMarketModal(); loadAdminData(); } } catch (e) { showToast("Sync Error", "error"); } b.innerText = "Deploy Node Listing"; b.disabled = false; }
        async function toggleUserStatus(e, s) { const n = s === 'ACTIVE' ? 'BANNED' : 'ACTIVE'; openConfirmModal(`Node ${n}`, `Modify access for ${e}?`, async () => { const r = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_toggle_user', email: e, status: n }) }); const res = await r.json(); if(res.success) { showToast(res.message, "success"); loadAdminData(); } }, n === 'BANNED' ? 'danger' : 'info'); }
        async function deleteMarket(m, a) { openConfirmModal("Delete", `Remove ${a} for ${m}?`, async () => { const r = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_manage_market', mode: 'delete', merchant: m, asset: a }) }); const res = await r.json(); if(res.success) { showToast("Pair Removed", "success"); loadAdminData(); } }, 'danger'); }
        async function sendGlobalBroadcast() { const msg = document.getElementById('broadcastMsg').value; if(!msg) return showToast("Empty signal", "error"); try { const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'admin_send_broadcast', message: msg }) }); const r = await res.json(); if(r.success) showToast("Signal Dispatched", "success"); } catch (e) { showToast("Error", "error"); } }

        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active', 'text-blue-400'); b.classList.add('text-slate-500'); }); document.getElementById(`tab-${id}`).classList.remove('hidden'); document.getElementById(`tabBtn-${id}`).classList.add('active', 'text-blue-400'); }
        function showToast(m, t) { const c = document.getElementById('toastContainer'); const toast = document.createElement('div'); toast.className = `toast glass-panel p-3 rounded-xl border ${t === 'success' ? 'border-green-500/50' : 'border-red-500/50'} shadow-2xl`; toast.innerHTML = `<span class="text-[9px] font-black uppercase text-white">${m}</span>`; c.appendChild(toast); setTimeout(() => toast.classList.add('show'), 100); setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 500); }, 3000); }

        window.onload = loadAdminData;
    </script>
</body>
</html>
